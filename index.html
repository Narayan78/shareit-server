<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional File Transfer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-ring {
            0% { transform: scale(0.95); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(0.95); opacity: 1; }
        }
        .pulse-animation { animation: pulse-ring 2s ease-in-out infinite; }
        
        .dropzone {
            border: 3px dashed #cbd5e1;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .dropzone.dragover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
            transform: scale(1.02);
        }
        .dropzone::before {
            content: '';
            position: absolute;
            top: -2px; right: -2px; bottom: -2px; left: -2px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
            border-radius: 12px;
        }
        .dropzone.dragover::before { opacity: 0.1; }
        
        .speed-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .slide-up { animation: slide-up 0.4s ease-out; }
        
        .progress-bar {
            transition: width 0.3s ease-out;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .connection-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .connected { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .connecting { background: #f59e0b; animation: pulse 1s ease-in-out infinite; }
        .disconnected { background: #ef4444; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">

    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg flex items-center justify-center">
                        <span class="text-white text-xl font-bold">‚ö°</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">File Transfer Pro</h1>
                        <p class="text-xs text-gray-500">Secure WebSocket Transfer</p>
                    </div>
                </div>
                <div id="connectionStatus" class="flex items-center text-sm">
                    <span class="connection-indicator disconnected"></span>
                    <span class="text-gray-600">Disconnected</span>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- Mode Selection -->
        <div id="modeSelection" class="slide-up">
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Choose Your Mode</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Send Mode -->
                    <button onclick="selectMode('sender')" 
                        class="group relative overflow-hidden bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl p-8 transition-all duration-300 transform hover:scale-105 hover:shadow-2xl">
                        <div class="relative z-10">
                            <div class="text-5xl mb-4">üì§</div>
                            <h3 class="text-2xl font-bold mb-2">Send Files</h3>
                            <p class="text-blue-100 text-sm">Transfer files to another device</p>
                            <div class="mt-4 flex items-center justify-center space-x-2 text-sm">
                                <span class="px-3 py-1 bg-white/20 rounded-full">Fast</span>
                                <span class="px-3 py-1 bg-white/20 rounded-full">Secure</span>
                            </div>
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    </button>
                    
                    <!-- Receive Mode -->
                    <button onclick="selectMode('receiver')" 
                        class="group relative overflow-hidden bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-xl p-8 transition-all duration-300 transform hover:scale-105 hover:shadow-2xl">
                        <div class="relative z-10">
                            <div class="text-5xl mb-4">üì•</div>
                            <h3 class="text-2xl font-bold mb-2">Receive Files</h3>
                            <p class="text-green-100 text-sm">Get files from another device</p>
                            <div class="mt-4 flex items-center justify-center space-x-2 text-sm">
                                <span class="px-3 py-1 bg-white/20 rounded-full">Reliable</span>
                                <span class="px-3 py-1 bg-white/20 rounded-full">Easy</span>
                            </div>
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Screen -->
        <div id="mainScreen" class="hidden">
            
            <!-- Connection Panel -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 slide-up">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">üîå</span>
                    Connection Setup
                </h2>
                <div class="flex gap-3">
                    <input 
                        id="sessionId" 
                        type="text"
                        class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors"
                        placeholder="Enter or generate Session ID">
                    <button 
                        onclick="generateSessionId()"
                        class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition-all">
                        üé≤ Random
                    </button>
                    <button 
                        id="connectBtn"
                        onclick="connect()"
                        class="px-8 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg">
                        Connect
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-3">üí° Share this Session ID with the other person to connect</p>
            </div>

            <!-- Sender Screen -->
            <div id="senderScreen" class="hidden space-y-6">
                
                <!-- Upload Zone -->
                <div class="bg-white rounded-2xl shadow-xl p-6 slide-up">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">üìÅ</span>
                        Upload Files
                    </h2>
                    
                    <div id="dropzone" class="dropzone rounded-xl p-12 text-center cursor-pointer">
                        <div class="text-5xl mb-4">üìé</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Drop files here</h3>
                        <p class="text-gray-500 mb-4">or click to browse</p>
                        <div class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-medium">
                            <span>Choose Files</span>
                        </div>
                        <input type="file" id="fileInput" multiple class="hidden">
                    </div>
                </div>

                <!-- Transfer Queue -->
                <div id="queuePanel" class="bg-white rounded-2xl shadow-xl p-6 hidden slide-up">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                            <span class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">üìä</span>
                            Transfer Queue
                        </h2>
                        <button onclick="clearQueue()" class="text-sm text-red-600 hover:text-red-700 font-medium">Clear All</button>
                    </div>
                    <div id="fileQueue" class="space-y-3"></div>
                </div>

                <!-- Progress Panel -->
                <div id="progressPanel" class="bg-white rounded-2xl shadow-xl p-6 hidden slide-up">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">‚ö°</span>
                        Transfer Progress
                    </h2>
                    <div id="currentTransfer" class="mb-4"></div>
                    <div id="stats" class="grid grid-cols-3 gap-4 mt-4"></div>
                </div>
            </div>

            <!-- Receiver Screen -->
            <div id="receiverScreen" class="hidden space-y-6">
                
                <!-- Waiting State -->
                <div id="waitingState" class="bg-white rounded-2xl shadow-xl p-12 text-center slide-up">
                    <div class="pulse-animation inline-block mb-6">
                        <div class="w-24 h-24 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto">
                            <span class="text-4xl">üì°</span>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-3">Waiting for Sender...</h2>
                    <p class="text-gray-600 mb-6">Make sure the sender has the same Session ID</p>
                    <div class="inline-flex items-center space-x-2 px-6 py-3 bg-green-100 text-green-700 rounded-xl">
                        <span class="animate-pulse">‚óè</span>
                        <span class="font-medium">Ready to receive</span>
                    </div>
                </div>

                <!-- Receiving Progress -->
                <div id="receivingPanel" class="bg-white rounded-2xl shadow-xl p-6 hidden slide-up">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">üì•</span>
                        Receiving Files
                    </h2>
                    <div id="receiveProgress"></div>
                    <div id="receiveStats" class="grid grid-cols-2 gap-4 mt-4"></div>
                </div>

                <!-- Downloaded Files -->
                <div id="downloadedPanel" class="bg-white rounded-2xl shadow-xl p-6 hidden slide-up">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">üíæ</span>
                        Downloaded Files
                    </h2>
                    <div id="downloadList" class="space-y-3"></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            SERVER_URL: 'wss://shareit-server-7.onrender.com',
            CHUNK_SIZE: 256 * 1024, // 256KB - optimized for speed
            MAX_BUFFER: 1024 * 1024, // 1MB buffer threshold
            HEADER_MARKER: new Uint8Array([0xFF, 0xFE, 0xFD, 0xFC]),
            RECONNECT_DELAY: 3000
        };

        // State
        let state = {
            ws: null,
            mode: null,
            sessionId: null,
            fileQueue: [],
            currentFile: null,
            isTransferring: false,
            stats: {
                totalBytes: 0,
                transferredBytes: 0,
                startTime: null,
                filesCompleted: 0,
                currentSpeed: 0
            },
            receivedFiles: []
        };

        // ===========================
        // UI HELPERS
        // ===========================
        
        function selectMode(mode) {
            state.mode = mode;
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            
            if (mode === 'sender') {
                document.getElementById('senderScreen').classList.remove('hidden');
                setupDropzone();
            } else {
                document.getElementById('receiverScreen').classList.remove('hidden');
            }
        }

        function generateSessionId() {
            const id = Math.random().toString(36).substring(2, 10).toUpperCase();
            document.getElementById('sessionId').value = id;
        }

        function updateConnectionStatus(status) {
            const indicator = document.querySelector('.connection-indicator');
            const text = document.querySelector('#connectionStatus span:last-child');
            
            indicator.className = 'connection-indicator';
            if (status === 'connected') {
                indicator.classList.add('connected');
                text.textContent = 'Connected';
                text.className = 'text-green-600 font-medium';
            } else if (status === 'connecting') {
                indicator.classList.add('connecting');
                text.textContent = 'Connecting...';
                text.className = 'text-yellow-600';
            } else {
                indicator.classList.add('disconnected');
                text.textContent = 'Disconnected';
                text.className = 'text-gray-600';
            }
        }

        function showNotification(message, type = 'info') {
            // Simple notification - could be enhanced with a toast library
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ===========================
        // CONNECTION
        // ===========================
        
        function connect() {
            const sessionId = document.getElementById('sessionId').value.trim();
            if (!sessionId) {
                alert('Please enter a Session ID');
                return;
            }

            state.sessionId = sessionId;
            const url = `${CONFIG.SERVER_URL}/ws/${sessionId}/${state.mode}/${state.mode}`;
            
            updateConnectionStatus('connecting');
            state.ws = new WebSocket(url);
            state.ws.binaryType = 'arraybuffer';

            state.ws.onopen = handleConnect;
            state.ws.onmessage = handleMessage;
            state.ws.onclose = handleDisconnect;
            state.ws.onerror = handleError;

            document.getElementById('connectBtn').disabled = true;
            document.getElementById('sessionId').disabled = true;
        }

        function handleConnect() {
            updateConnectionStatus('connected');
            showNotification(`Connected as ${state.mode}`, 'success');
            
            if (state.mode === 'receiver') {
                document.getElementById('waitingState').classList.remove('hidden');
            }
        }

        function handleDisconnect() {
            updateConnectionStatus('disconnected');
            showNotification('Disconnected from server', 'warning');
            
            // Enable reconnection
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('sessionId').disabled = false;
        }

        function handleError(error) {
            console.error('WebSocket error:', error);
            showNotification('Connection error occurred', 'error');
        }

        function handleMessage(event) {
            if (typeof event.data === 'string') {
                try {
                    const msg = JSON.parse(event.data);
                    handleControlMessage(msg);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                }
            } else if (event.data instanceof ArrayBuffer) {
                handleBinaryData(event.data);
            }
        }

        function handleControlMessage(msg) {
            if (msg.type === 'ping') {
                state.ws.send(JSON.stringify({ type: 'pong' }));
            } else if (msg.type === 'speed_update') {
                updateSpeedDisplay(msg.speed);
            } else if (msg.status === 'ready') {
                showNotification('Receiver connected! Ready to send', 'success');
                if (state.mode === 'sender' && state.fileQueue.length > 0) {
                    startTransferQueue();
                }
            } else if (msg.status === 'connected' && state.mode === 'receiver') {
                document.getElementById('waitingState').classList.add('hidden');
                document.getElementById('receivingPanel').classList.remove('hidden');
                showNotification('Sender connected! Ready to receive', 'success');
            }
        }

        // ===========================
        // SENDER: FILE HANDLING
        // ===========================
        
        function setupDropzone() {
            const dz = document.getElementById('dropzone');
            const input = document.getElementById('fileInput');

            dz.onclick = () => input.click();
            dz.ondragover = (e) => {
                e.preventDefault();
                dz.classList.add('dragover');
            };
            dz.ondragleave = () => dz.classList.remove('dragover');
            dz.ondrop = (e) => {
                e.preventDefault();
                dz.classList.remove('dragover');
                handleFiles(Array.from(e.dataTransfer.files));
            };
            input.onchange = (e) => handleFiles(Array.from(e.target.files));
        }

        function handleFiles(files) {
            if (!state.ws || state.ws.readyState !== WebSocket.OPEN) {
                alert('Please connect first!');
                return;
            }

            state.fileQueue.push(...files);
            state.stats.totalBytes += files.reduce((sum, f) => sum + f.size, 0);
            
            updateFileQueue();
            document.getElementById('queuePanel').classList.remove('hidden');

            // Auto-start if not already transferring
            if (!state.isTransferring) {
                startTransferQueue();
            }
        }

        function updateFileQueue() {
            const container = document.getElementById('fileQueue');
            container.innerHTML = state.fileQueue.map((file, idx) => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-xl">${getFileIcon(file.type)}</span>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">${file.name}</p>
                            <p class="text-sm text-gray-500">${formatBytes(file.size)}</p>
                        </div>
                    </div>
                    <button onclick="removeFromQueue(${idx})" class="text-red-500 hover:text-red-700 transition-colors">
                        <span class="text-xl">√ó</span>
                    </button>
                </div>
            `).join('');
        }

        function removeFromQueue(idx) {
            const file = state.fileQueue[idx];
            state.stats.totalBytes -= file.size;
            state.fileQueue.splice(idx, 1);
            updateFileQueue();
            
            if (state.fileQueue.length === 0) {
                document.getElementById('queuePanel').classList.add('hidden');
            }
        }

        function clearQueue() {
            if (state.isTransferring) {
                alert('Cannot clear queue while transferring');
                return;
            }
            state.fileQueue = [];
            state.stats.totalBytes = 0;
            document.getElementById('queuePanel').classList.add('hidden');
        }

        // ===========================
        // SENDER: FILE TRANSFER
        // ===========================
        
        async function startTransferQueue() {
            if (state.isTransferring || state.fileQueue.length === 0) return;
            
            state.isTransferring = true;
            state.stats.startTime = Date.now();
            state.stats.transferredBytes = 0;
            
            document.getElementById('progressPanel').classList.remove('hidden');

            while (state.fileQueue.length > 0) {
                const file = state.fileQueue.shift();
                await sendFile(file);
                state.stats.filesCompleted++;
                updateFileQueue();
            }

            state.isTransferring = false;
            showNotification('All files transferred successfully!', 'success');
        }

        async function sendFile(file) {
            // Send metadata header
            const header = createMetadataHeader(file.name, file.size, file.type);
            state.ws.send(header);

            // Update UI
            document.getElementById('currentTransfer').innerHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm">
                                <span class="text-2xl">${getFileIcon(file.type)}</span>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">${file.name}</p>
                                <p class="text-sm text-gray-600">${formatBytes(file.size)}</p>
                            </div>
                        </div>
                        <div id="filePercent" class="text-2xl font-bold text-blue-600">0%</div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div id="fileProgress" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            `;

            let offset = 0;
            const startTime = Date.now();

            while (offset < file.size) {
                // Wait for buffer to drain
                while (state.ws.bufferedAmount > CONFIG.MAX_BUFFER) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }

                const chunk = file.slice(offset, offset + CONFIG.CHUNK_SIZE);
                const buffer = await chunk.arrayBuffer();
                state.ws.send(buffer);
                
                offset += chunk.size;
                state.stats.transferredBytes += chunk.size;

                // Update progress
                const percent = Math.round((offset / file.size) * 100);
                document.getElementById('fileProgress').style.width = `${percent}%`;
                document.getElementById('filePercent').textContent = `${percent}%`;

                // Update stats
                const elapsed = (Date.now() - startTime) / 1000;
                const speed = offset / elapsed;
                state.stats.currentSpeed = speed;
                updateStatsDisplay();
            }

            showNotification(`Sent: ${file.name}`, 'success');
        }

        function createMetadataHeader(name, size, type) {
            const metadata = { name, size, type: type || 'application/octet-stream' };
            const jsonStr = JSON.stringify(metadata);
            const encoder = new TextEncoder();
            const jsonBytes = encoder.encode(jsonStr);
            
            const header = new Uint8Array(4 + 4 + jsonBytes.length);
            header.set(CONFIG.HEADER_MARKER, 0);
            
            const view = new DataView(header.buffer);
            view.setUint32(4, jsonBytes.length, false);
            header.set(jsonBytes, 8);
            
            return header.buffer;
        }

        function updateStatsDisplay() {
            const { transferredBytes, totalBytes, currentSpeed, filesCompleted } = state.stats;
            const remaining = totalBytes - transferredBytes;
            const eta = currentSpeed > 0 ? remaining / currentSpeed : 0;

            document.getElementById('stats').innerHTML = `
                <div class="text-center p-3 bg-blue-50 rounded-lg">
                    <div class="text-sm text-gray-600 mb-1">Speed</div>
                    <div class="speed-badge text-white px-3 py-1 rounded-full inline-block font-bold">
                        ${formatBytes(currentSpeed)}/s
                    </div>
                </div>
                <div class="text-center p-3 bg-green-50 rounded-lg">
                    <div class="text-sm text-gray-600 mb-1">Completed</div>
                    <div class="text-xl font-bold text-green-600">${filesCompleted}</div>
                </div>
                <div class="text-center p-3 bg-purple-50 rounded-lg">
                    <div class="text-sm text-gray-600 mb-1">ETA</div>
                    <div class="text-xl font-bold text-purple-600">${formatTime(eta)}</div>
                </div>
            `;
        }

        function updateSpeedDisplay(speed) {
            state.stats.currentSpeed = speed;
        }

        // ===========================
        // RECEIVER: FILE HANDLING
        // ===========================
        
        function handleBinaryData(data) {
            const bytes = new Uint8Array(data);
            
            // Check for metadata header
            if (bytes.length > 8 && 
                bytes[0] === CONFIG.HEADER_MARKER[0] && 
                bytes[1] === CONFIG.HEADER_MARKER[1]) {
                
                const view = new DataView(data);
                const jsonLength = view.getUint32(4, false);
                const jsonBytes = bytes.slice(8, 8 + jsonLength);
                const decoder = new TextDecoder();
                const metadata = JSON.parse(decoder.decode(jsonBytes));
                
                startReceivingFile(metadata);
                return;
            }

            // Regular chunk
            if (state.currentFile) {
                receiveChunk(bytes);
            }
        }

        function startReceivingFile(metadata) {
            state.currentFile = {
                name: metadata.name,
                size: metadata.size,
                type: metadata.type,
                chunks: [],
                received: 0,
                startTime: Date.now()
            };

            document.getElementById('receiveProgress').innerHTML = `
                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm">
                                <span class="text-2xl">${getFileIcon(metadata.type)}</span>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">${metadata.name}</p>
                                <p class="text-sm text-gray-600">${formatBytes(metadata.size)}</p>
                            </div>
                        </div>
                        <div id="recvPercent" class="text-2xl font-bold text-green-600">0%</div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div id="recvProgress" class="progress-bar h-full rounded-full bg-gradient-to-r from-green-500 to-blue-500" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between mt-2 text-sm text-gray-600">
                        <span id="recvSize">0 B</span>
                        <span id="recvSpeed">0 B/s</span>
                    </div>
                </div>
            `;

            showNotification(`Receiving: ${metadata.name}`, 'info');
        }

        function receiveChunk(bytes) {
            state.currentFile.chunks.push(bytes);
            state.currentFile.received += bytes.length;

            const percent = Math.min(100, Math.round((state.currentFile.received / state.currentFile.size) * 100));
            const elapsed = (Date.now() - state.currentFile.startTime) / 1000;
            const speed = state.currentFile.received / elapsed;

            // Update UI
            const progressBar = document.getElementById('recvProgress');
            const percentEl = document.getElementById('recvPercent');
            const sizeEl = document.getElementById('recvSize');
            const speedEl = document.getElementById('recvSpeed');

            if (progressBar) progressBar.style.width = `${percent}%`;
            if (percentEl) percentEl.textContent = `${percent}%`;
            if (sizeEl) sizeEl.textContent = formatBytes(state.currentFile.received);
            if (speedEl) speedEl.textContent = `${formatBytes(speed)}/s`;

            // Update receive stats
            updateReceiveStats(speed);

            // Check if complete
            if (state.currentFile.received >= state.currentFile.size) {
                completeFileReceive();
            }
        }

        function completeFileReceive() {
            const blob = new Blob(state.currentFile.chunks, { type: state.currentFile.type });
            const url = URL.createObjectURL(blob);
            
            const fileInfo = {
                name: state.currentFile.name,
                size: state.currentFile.size,
                type: state.currentFile.type,
                url: url,
                timestamp: new Date().toISOString()
            };

            state.receivedFiles.push(fileInfo);
            displayDownloadedFile(fileInfo);

            showNotification(`Received: ${state.currentFile.name}`, 'success');
            state.currentFile = null;

            document.getElementById('downloadedPanel').classList.remove('hidden');
        }

        function displayDownloadedFile(file) {
            const container = document.getElementById('downloadList');
            const fileDiv = document.createElement('div');
            fileDiv.className = 'flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-xl hover:shadow-md transition-all';
            fileDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm">
                        <span class="text-2xl">${getFileIcon(file.type)}</span>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900">${file.name}</p>
                        <p class="text-sm text-gray-600">${formatBytes(file.size)} ‚Ä¢ ${new Date(file.timestamp).toLocaleTimeString()}</p>
                    </div>
                </div>
                <a href="${file.url}" download="${file.name}" 
                    class="px-6 py-2 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white rounded-lg font-medium transition-all transform hover:scale-105 shadow-md">
                    üíæ Download
                </a>
            `;
            container.insertBefore(fileDiv, container.firstChild);
        }

        function updateReceiveStats(speed) {
            document.getElementById('receiveStats').innerHTML = `
                <div class="text-center p-3 bg-green-50 rounded-lg">
                    <div class="text-sm text-gray-600 mb-1">Download Speed</div>
                    <div class="speed-badge text-white px-3 py-1 rounded-full inline-block font-bold">
                        ${formatBytes(speed)}/s
                    </div>
                </div>
                <div class="text-center p-3 bg-blue-50 rounded-lg">
                    <div class="text-sm text-gray-600 mb-1">Files Received</div>
                    <div class="text-xl font-bold text-blue-600">${state.receivedFiles.length}</div>
                </div>
            `;
        }

        // ===========================
        // UTILITY FUNCTIONS
        // ===========================
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            if (!seconds || !isFinite(seconds)) return '--';
            if (seconds < 60) return `${Math.round(seconds)}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${Math.round(seconds % 60)}s`;
            return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
        }

        function getFileIcon(mimeType) {
            if (!mimeType) return 'üìÑ';
            if (mimeType.startsWith('image/')) return 'üñºÔ∏è';
            if (mimeType.startsWith('video/')) return 'üé¨';
            if (mimeType.startsWith('audio/')) return 'üéµ';
            if (mimeType.includes('pdf')) return 'üìï';
            if (mimeType.includes('zip') || mimeType.includes('compressed')) return 'üóúÔ∏è';
            if (mimeType.includes('text')) return 'üìù';
            if (mimeType.includes('word')) return 'üìò';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'üìä';
            if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return 'üìΩÔ∏è';
            return 'üìÑ';
        }

        // Auto-generate session ID on load
        window.addEventListener('DOMContentLoaded', () => {
            generateSessionId();
        });
    </script>

</body>
</html>
